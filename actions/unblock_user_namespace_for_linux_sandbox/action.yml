# *******************************************************************************
# Copyright (c) 2024 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************

name: "Allow linux-sandbox to create user namespace"
description: "Configures apparmor to allow Bazel's linux-sandbox to create user namespaces on Ubuntu hosts."

branding:
  icon: command
  color: gray-dark

runs:
  using: composite
  steps:
    - name: Allow linux-sandbox to create user namespace
      run: |
        INSTALL_BASE=$(bazel info install_base)
        sudo bash -c "cat >>/etc/apparmor.d/score-linux-sandbox" <<-EOF
        abi <abi/4.0>,
        include <tunables/global>
        
        profile linux-sandbox ${INSTALL_BASE}/linux-sandbox flags=(unconfined) {
          userns,
        
          # Site-specific additions and overrides. See local/README for details.
          include if exists <local/score-linux-sandbox>
        }
        EOF
        less /etc/apparmor.d/score-linux-sandbox
        sudo apparmor_parser -r /etc/apparmor.d/score-linux-sandbox
        ${INSTALL_BASE}/linux-sandbox "/bin/true"
      shell: bash
